<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senarai Permohonan Ujian Outsource Hospital Baling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>

    <!-- PWA & Favicon Configuration -->
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="./assets/experiment.png" type="image/png">
    <link rel="apple-touch-icon" href="./assets/experiment.png">
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;Blood Test Records HB&quot;,
        &quot;short_name&quot;: &quot;HB Records&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#ffffff&quot;,
        &quot;theme_color&quot;: &quot;#007BFF&quot;,
        &quot;description&quot;: &quot;Blood Test List Generator for Hospital Baling.&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;./assets/experiment.png&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/png&quot; },
            { &quot;src&quot;: &quot;./assets/experiment.png&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot; }
        ]
    }">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            transition: opacity 0.3s ease;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            color: #fff;
            text-align: center;
            border-radius: 0.25rem;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #ddd;
            background-color: white;
            z-index: 99;
            max-height: 150px;
            overflow-y: auto;
            width: inherit;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-section, #print-section *,
            #filtered-print-section, #filtered-print-section * {
                visibility: visible;
            }
            #print-section, #filtered-print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="text-center bg-white p-8 rounded-lg shadow-lg">
            <img src="./assets/experiment.png" alt="Logo" class="w-16 h-16 mx-auto mb-4">
            <h1 class="text-2xl font-bold mb-2">Pengurusan Spesimen Outsource</h1>
            <p class="text-gray-600 mb-6">Sila log masuk dengan Google.</p>
            <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mx-auto">
                <i class="fab fa-google mr-2"></i>Log Masuk Google
            </button>
            <p id="auth-error" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden">
        <div id="main-page" class="container mx-auto p-4 md:p-8">
            <!-- Header -->
            <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
                <div class="flex items-center space-x-3">
                    <img src="./assets/experiment.png" alt="Logo" class="w-10 h-10">
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-gray-700">Jabatan Patologi & Transfusi</h1>
                        <p class="text-md text-gray-600">Hospital Baling</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 no-print">
                    <div class="text-right">
                        <p id="user-email" class="text-sm font-medium text-gray-700"></p>
                        <button id="logout-button" class="text-xs text-blue-600 hover:underline">Daftar Keluar</button>
                    </div>
                    <button id="show-records-button" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-history mr-2"></i>Lihat Rekod
                    </button>
                    <button id="clear-list-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Mula Senarai Baru
                    </button>
                </div>
            </header>

            <main>
                <!-- Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-white p-4 rounded-lg shadow no-print">
                    <div class="md:col-span-2">
                        <label for="test-center" class="block text-sm font-medium text-gray-700 mb-1">Institusi Ujian</label>
                        <select id="test-center" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Hospital Tuanku Fauziah, Kangar</option>
                            <option>Hospital Pulau Pinang</option>
                            <option>Hospital Kuala Lumpur</option>
                            <option>Makmal Kesihatan Awam Kebangsaan, Ipoh</option>
                            <option>Makmal Kesihatan Awam Kebangsaan, Sungai Buloh </option>
                            <option>Hospital Sungai Buloh</option>
                            <option>Hospital Putrajaya</option>
                            <option>Hospital Ampang</option>
                            <option>Hospital Tunku Azizah, Kuala Lumpur</option>
                            <option>Hospital Seberang Jaya</option>
                            <option>Hospital Selayang</option>
                            <option>Jabatan Kimia Pulau Pinang</option>
                            <option>Institut Perubatan dan Pergigian Termaju, Bertam, Pulau Pinang</option>
                            <option>Pusat Darah Negara</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="print-save-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fas fa-print mr-2"></i>Cetak & Simpan
                        </button>
                    </div>
                </div>

                <!-- Patient Input Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-8 no-print">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Tambah Ujian</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-2 relative">
                            <input type="text" id="patient-name" placeholder="Nama Pesakit" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                            <div id="patient-name-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                         <div class="relative">
                            <input type="text" id="patient-id" placeholder="No. KP / RN" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                            <div id="patient-id-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div class="md:col-span-2 relative">
                            <input type="text" id="test-name" placeholder="Nama Ujian (cth: FBC, RP)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                            <div id="test-name-suggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <button id="add-patient-button" class="md:col-span-5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <i class="fas fa-user-plus mr-2"></i>Tambah Senarai
                        </button>
                    </div>
                </div>

                <!-- Test List Table -->
                <div id="print-section" class="bg-white p-4 rounded-lg shadow-md">
                     <div class="mb-4 hidden" id="print-header">
                         <h2 class="text-xl font-bold text-center">HOSPITAL BALING | PERMOHONAN UJIAN DARAH</h2>
                         <div class="flex justify-between mt-2">
                             <div>
                                 <strong>Institusi:</strong> <span id="print-test-center"></span>
                             </div>
                             <div>
                                 <strong>Tarikh Hantar:</strong> <span id="print-date"></span>
                             </div>
                         </div>
                     </div>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">No.</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Nama Pesakit</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">No. KP / RN</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Nama Ujian</th>
                                <th class="p-3 text-center text-sm font-semibold text-gray-700 border border-gray-300 no-print">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="test-list">
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <div id="records-page" class="container mx-auto p-4 md:p-8 hidden">
            <!-- Header -->
            <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
                <h1 class="text-xl md:text-2xl font-bold text-gray-700">Semua Rekod</h1>
                <button id="back-to-main-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali
                </button>
            </header>

            <main>
                <!-- Filter Controls -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                    <h2 class="text-lg font-semibold mb-2 text-gray-800">Tapis Rekod</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <input type="text" id="filter-name" placeholder="Tapis Nama..." class="p-2 border border-gray-300 rounded-md">
                        <input type="text" id="filter-id" placeholder="Tapis No. KP..." class="p-2 border border-gray-300 rounded-md">
                        <select id="filter-center" class="p-2 border border-gray-300 rounded-md"></select>
                        <div>
                            <label for="filter-date" class="text-sm text-gray-600">Tapis Tarikh</label>
                            <input type="date" id="filter-date" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-3">
                        <button id="apply-filters-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Tapis</button>
                        <button id="clear-filters-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Kosongkan</button>
                        <button id="print-filtered-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-print mr-2"></i>Cetak (Tapis)</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div id="records-loading" class="text-center p-8">
                        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                        <p class="mt-2 text-gray-600">Memuatkan Rekod...</p>
                    </div>
                    <table class="w-full border-collapse hidden" id="records-table-container">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Nama Pesakit</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Nombor KP</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Nama Ujian</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Pusat Ujian</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-700 border border-gray-300">Tarikh Hantar</th>
                                <th class="p-3 text-center text-sm font-semibold text-gray-700 border border-gray-300 no-print">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="records-list">
                        </tbody>
                    </table>
                    <div id="pagination-controls" class="mt-4 flex justify-center items-center space-x-2 no-print"></div>
                </div>
            </main>
        </div>
    </div>


    <!-- Local List Edit Modal -->
    <div id="local-edit-modal" class="modal">
        <div class="modal-content shadow-lg">
            <h2 class="text-lg font-semibold mb-4">Edit Senarai Semasa</h2>
            <input type="hidden" id="local-edit-index">
            <div class="space-y-4">
                <input type="text" id="local-edit-patient-name" placeholder="Nama Pesakit" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="local-edit-patient-id" placeholder="No. KP / RN" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="local-edit-test-name" placeholder="Nama Ujian" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="local-edit-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button>
                <button id="local-edit-modal-save" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Firestore Record Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content shadow-lg">
            <h2 class="text-lg font-semibold mb-4">Kemaskini Rekod</h2>
            <input type="hidden" id="edit-doc-id">
            <div class="space-y-4">
                <input type="text" id="edit-patient-name" placeholder="Nama Pesakit" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="edit-patient-id" placeholder="No. KP / RN" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="edit-test-name" placeholder="Nama Ujian" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="text" id="edit-test-center" placeholder="Pusat Ujian" class="w-full p-2 border border-gray-300 rounded-md">
                <input type="date" id="edit-date-sent" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="edit-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button>
                <button id="edit-modal-save" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content shadow-lg">
            <h2 class="text-lg font-semibold mb-4">Pengesahan</h2>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button>
                <button id="confirm-modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sahkan</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    <div id="filtered-print-section" class="hidden"></div>

    <!-- Firebase SDK - Modular v9+ -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, writeBatch, Timestamp, orderBy, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // ===============================================================
        // YOUR FIREBASE CONFIGURATION
        // ===============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA1Gg00IWkhLdXBrLlmtE0BxXB-bu6f8M8",
            authDomain: "outsourcedatabase.firebaseapp.com",
            projectId: "outsourcedatabase",
            storageBucket: "outsourcedatabase.appspot.com",
            messagingSenderId: "697235910002",
            appId: "1:697235910002:web:18ea5edf7479bfbb3801eb"
        };
        // ===============================================================
        
        // ===============================================================
        // ADD YOUR TEAM'S EMAILS HERE
        // ===============================================================
        const AUTHORIZED_EMAILS = [
            "patologi_hbaling@moh.gov.my", 
            "anonviranon@gmail.com",
            "zarina.idrus@moh.gov.my"
        ];
        // ===============================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const recordsCollection = collection(db, "bloodTestRecords");

        let patientList = [];
        let allFetchedRecords = []; // Store all records for client-side filtering and suggestions
        let currentlyDisplayedRecords = []; // Store currently visible records for printing
        let currentPage = 1;
        const recordsPerPage = 20;

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const authError = document.getElementById('auth-error');
        const userEmailDisplay = document.getElementById('user-email');
        const mainPage = document.getElementById('main-page');
        const recordsPage = document.getElementById('records-page');
        const localEditModal = document.getElementById('local-edit-modal');
        const editModal = document.getElementById('edit-modal');
        const confirmModal = document.getElementById('confirm-modal');

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user && AUTHORIZED_EMAILS.includes(user.email)) {
                // User is signed in and authorized
                loginScreen.style.display = 'none';
                appContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                initialize();
            } else {
                // User is not signed in or not authorized
                loginScreen.style.display = 'flex';
                appContainer.classList.add('hidden');
                if (user) { // If user is logged in but not authorized
                    authError.textContent = 'Akses ditolak. Guna akaun yang dibenarkan.';
                    signOut(auth); // Sign them out
                }
            }
        });

        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch(error => {
                    console.error("Google Sign-In Error:", error);
                    authError.textContent = `Error: ${error.message}`;
                });
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'hb-records-cache-v7';
                const urlsToCache = [ '.', './assets/experiment.png' ];
                self.addEventListener('install', event => {
                    event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));
                });
            `;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl);
        }

        // --- UI Feedback (Toast) ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = "toast show"; // Reset classes
            toast.style.backgroundColor = isError ? '#dc2626' : '#333'; // red-600 for error
            setTimeout(() => { toast.classList.remove('show'); }, 4000); // Increased duration for longer messages
        }

        // --- Main Page Logic ---
        function addPatient() {
            const name = document.getElementById('patient-name').value.trim();
            const id = document.getElementById('patient-id').value.trim();
            const test = document.getElementById('test-name').value.trim();

            if (name && id && test) {
                patientList.push({ name, id, test });
                renderTable();
                document.getElementById('patient-name').value = '';
                document.getElementById('patient-id').value = '';
                document.getElementById('test-name').value = '';
                document.getElementById('patient-name').focus();
            } else {
                showToast('Sila isi semua maklumat pesakit.', true);
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('test-list');
            tableBody.innerHTML = '';
            if (patientList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Tiada pesakit dalam senarai.</td></tr>`;
                return;
            }
            patientList.forEach((patient, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 border border-gray-300">${index + 1}</td>
                    <td class="p-3 border border-gray-300">${patient.name}</td>
                    <td class="p-3 border border-gray-300">${patient.id}</td>
                    <td class="p-3 border border-gray-300">${patient.test}</td>
                    <td class="p-3 border border-gray-300 text-center no-print space-x-3">
                        <button class="edit-local-btn text-blue-500 hover:text-blue-700">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-local-btn text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                row.querySelector('.edit-local-btn').addEventListener('click', () => openLocalEditModal(index));
                row.querySelector('.delete-local-btn').addEventListener('click', () => deletePatient(index));
                tableBody.appendChild(row);
            });
        }

        function deletePatient(index) {
            patientList.splice(index, 1);
            renderTable();
        }

        function clearList() {
            showConfirm('Anda pasti untuk mulakan senarai baru? Senarai semasa akan dipadam.', () => {
                patientList = [];
                renderTable();
                showToast('Senarai baru dimulakan.');
            });
        }

        async function printAndSave() {
            if (patientList.length === 0) {
                showToast("Senarai kosong. Sila tambah pesakit.", true);
                return;
            }

            // --- Duplicate Check Logic ---
            const dateSent = new Date();
            const dateSentString = dateSent.toLocaleDateString('en-GB'); // "DD/MM/YYYY"
            
            const recordsToSave = [];
            const duplicateRecords = [];

            for (const patient of patientList) {
                const isDuplicate = allFetchedRecords.some(record => {
                    const recordDateString = record.dateSent.toDate().toLocaleDateString('en-GB');
                    return record.patientName.toLowerCase() === patient.name.toLowerCase() &&
                           record.patientId.toLowerCase() === patient.id.toLowerCase() &&
                           record.testName.toLowerCase() === patient.test.toLowerCase() &&
                           recordDateString === dateSentString;
                });

                if (isDuplicate) {
                    duplicateRecords.push(patient);
                } else {
                    const isDuplicateInCurrentList = recordsToSave.some(p => 
                        p.name.toLowerCase() === patient.name.toLowerCase() &&
                        p.id.toLowerCase() === patient.id.toLowerCase() &&
                        p.test.toLowerCase() === patient.test.toLowerCase()
                    );
                    if (isDuplicateInCurrentList) {
                         duplicateRecords.push(patient);
                    } else {
                        recordsToSave.push(patient);
                    }
                }
            }

            // --- Execution Logic ---
            const executeSave = async (records) => {
                if (records.length === 0) {
                    showToast("Tiada rekod baru. Semua adalah salinan.", true);
                    return;
                }

                const testCenter = document.getElementById('test-center').value;
                const batch = writeBatch(db);
                records.forEach(patient => {
                    const newRecordRef = doc(collection(db, "bloodTestRecords"));
                    batch.set(newRecordRef, {
                        patientName: patient.name,
                        patientId: patient.id,
                        testName: patient.test,
                        testCenter: testCenter,
                        dateSent: Timestamp.fromDate(dateSent)
                    });
                });

                try {
                    await batch.commit();
                    let successMessage = `${records.length} rekod baru disimpan.`;
                    if (duplicateRecords.length > 0) {
                        successMessage += ` ${duplicateRecords.length} salinan diabaikan.`;
                    }
                    showToast(successMessage);
                    
                    patientList = [];
                    renderTable();
                    
                    await fetchRecords();
                } catch (error) {
                    console.error("Error saving data to Firebase: ", error);
                    showToast("Gagal menyimpan data.", true);
                }
            };

            // --- Print and Confirmation Flow ---
            document.getElementById('print-test-center').innerText = document.getElementById('test-center').value;
            document.getElementById('print-date').innerText = dateSent.toLocaleDateString('en-GB');
            document.getElementById('print-header').classList.remove('hidden');
            window.print();
            document.getElementById('print-header').classList.add('hidden');

            if (duplicateRecords.length > 0) {
                let confirmMessage = `${duplicateRecords.length} dari ${patientList.length} rekod adalah salinan untuk hari ini. `;
                if (recordsToSave.length > 0) {
                    confirmMessage += `Teruskan untuk simpan ${recordsToSave.length} rekod baru sahaja?`;
                    showConfirm(confirmMessage, () => executeSave(recordsToSave));
                } else {
                    confirmMessage += `Tiada rekod baru akan disimpan.`;
                    showToast(confirmMessage, true);
                }
            } else {
                executeSave(recordsToSave);
            }
        }
        
        // --- Page Navigation ---
        function showMainPage() {
            mainPage.classList.remove('hidden');
            recordsPage.classList.add('hidden');
        }

        function showRecordsPage() {
            mainPage.classList.add('hidden');
            recordsPage.classList.remove('hidden');
            currentPage = 1;
            fetchRecords();
        }

        // --- Records Page & Data Fetching ---
        async function fetchRecords() {
            const loadingIndicator = document.getElementById('records-loading');
            const tableContainer = document.getElementById('records-table-container');
            const isOnRecordsPage = !recordsPage.classList.contains('hidden');

            if(isOnRecordsPage) {
                loadingIndicator.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            }

            try {
                const q = query(recordsCollection, orderBy("dateSent", "desc"));
                const snapshot = await getDocs(q);
                allFetchedRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                populateFilterOptions();
                
                if (isOnRecordsPage) {
                    renderRecordsTable(allFetchedRecords);
                }

            } catch (error) {
                console.error("Error fetching records: ", error);
                if (isOnRecordsPage) {
                    document.getElementById('records-list').innerHTML = `<tr><td colspan="6" class="text-center p-4">Gagal memuatkan rekod. Ralat: ${error.message}</td></tr>`;
                }
            } finally {
                if(isOnRecordsPage) {
                    loadingIndicator.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                }
            }
        }

        function renderRecordsTable(records) {
            currentlyDisplayedRecords = records;
            const recordsListBody = document.getElementById('records-list');
            recordsListBody.innerHTML = '';

            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const paginatedRecords = records.slice(startIndex, endIndex);

            if (paginatedRecords.length === 0 && records.length > 0) {
                // If on a page with no records (e.g., after deleting last item on a page)
                currentPage = Math.max(1, currentPage - 1);
                renderRecordsTable(records); // Re-render with the new page
                return;
            }
            
            if (records.length === 0) {
                recordsListBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Tiada rekod ditemui.</td></tr>';
            } else {
                paginatedRecords.forEach(record => {
                    const date = record.dateSent.toDate().toLocaleDateString('en-GB');
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.id = `row-${record.id}`;
                    row.innerHTML = `
                        <td class="p-3 border border-gray-300" data-field="patientName">${record.patientName}</td>
                        <td class="p-3 border border-gray-300" data-field="patientId">${record.patientId}</td>
                        <td class="p-3 border border-gray-300" data-field="testName">${record.testName}</td>
                        <td class="p-3 border border-gray-300" data-field="testCenter">${record.testCenter}</td>
                        <td class="p-3 border border-gray-300" data-field="dateSent">${date}</td>
                        <td class="p-3 border border-gray-300 text-center space-x-3 no-print">
                            <button class="edit-btn text-blue-500 hover:text-blue-700">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    row.querySelector('.edit-btn').addEventListener('click', () => openEditModal(record.id));
                    row.querySelector('.delete-btn').addEventListener('click', () => deleteRecord(record.id));
                    recordsListBody.appendChild(row);
                });
            }
            renderPaginationControls(records.length);
        }

        function renderPaginationControls(totalRecords) {
            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalRecords / recordsPerPage);

            if (totalPages <= 1) return;

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.className = 'px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50';
            if (currentPage === 1) {
                prevButton.disabled = true;
                prevButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            prevButton.addEventListener('click', () => {
                goToPage(currentPage - 1);
            });
            paginationControls.appendChild(prevButton);

            // Page Numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = 'px-3 py-1 rounded-md border border-gray-300';
                if (i === currentPage) {
                    pageButton.className += ' bg-blue-500 text-white border-blue-500';
                } else {
                    pageButton.className += ' bg-white text-gray-700 hover:bg-gray-50';
                }
                pageButton.addEventListener('click', () => {
                    goToPage(i);
                });
                paginationControls.appendChild(pageButton);
            }

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.className = 'px-3 py-1 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50';
            if (currentPage === totalPages) {
                nextButton.disabled = true;
                nextButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            nextButton.addEventListener('click', () => {
                goToPage(currentPage + 1);
            });
            paginationControls.appendChild(nextButton);
        }
        
        function goToPage(pageNumber) {
            currentPage = pageNumber;
            renderRecordsTable(currentlyDisplayedRecords);
        }

        function populateFilterOptions() {
            const centers = [...new Set(allFetchedRecords.map(record => record.testCenter))];
            const select = document.getElementById('filter-center');
            select.innerHTML = '<option value="">Semua Pusat</option>';
            centers.sort().forEach(center => {
                select.innerHTML += `<option value="${center}">${center}</option>`;
            });
        }

        function applyFilters() {
            currentPage = 1;
            const nameFilter = document.getElementById('filter-name').value.toLowerCase();
            const idFilter = document.getElementById('filter-id').value.toLowerCase();
            const centerFilter = document.getElementById('filter-center').value;
            const dateFilter = document.getElementById('filter-date').value;

            let filteredRecords = allFetchedRecords.filter(record => {
                const nameMatch = record.patientName.toLowerCase().includes(nameFilter);
                const idMatch = record.patientId.toLowerCase().includes(idFilter);
                const centerMatch = centerFilter ? record.testCenter === centerFilter : true;
                
                let dateMatch = true;
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const recordDate = record.dateSent.toDate();
                    dateMatch = recordDate.getFullYear() === filterDate.getFullYear() &&
                                recordDate.getMonth() === filterDate.getMonth() &&
                                recordDate.getDate() === filterDate.getDate();
                }
                
                return nameMatch && idMatch && centerMatch && dateMatch;
            });

            renderRecordsTable(filteredRecords);
        }

        function clearFilters() {
            currentPage = 1;
            document.getElementById('filter-name').value = '';
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-center').value = '';
            document.getElementById('filter-date').value = '';
            renderRecordsTable(allFetchedRecords);
        }

        function printFiltered() {
            if (currentlyDisplayedRecords.length === 0) {
                showToast("Tiada rekod untuk dicetak.", true);
                return;
            }

            const printArea = document.getElementById('filtered-print-section');
            const centerFilterValue = document.getElementById('filter-center').value;
            const testCenter = centerFilterValue || "Semua Pusat";
            const printDate = new Date().toLocaleDateString('en-GB');

            let printContent = `
                <div class="p-8">
                    <h2 class="text-xl font-bold text-center">HOSPITAL BALING|PERMOHONAN UJIAN DARAH</h2>
                    <div class="flex justify-between mt-2 mb-4">
                        <div><strong>Institusi:</strong> <span>${testCenter}</span></div>
                        <div><strong>Tarikh Cetak:</strong> <span>${printDate}</span></div>
                    </div>
                    <table class="w-full border-collapse" style="font-size: 10pt;">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left text-sm font-semibold text-gray-700 border border-gray-400">Nama Pesakit</th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-700 border border-gray-400">No. KP / RN</th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-700 border border-gray-400">Nama Ujian</th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-700 border border-gray-400">Pusat Ujian</th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-700 border border-gray-400">Tarikh Hantar</th>
                            </tr>
                        </thead>
                        <tbody>`;

            currentlyDisplayedRecords.forEach(record => {
                const date = record.dateSent.toDate().toLocaleDateString('en-GB');
                printContent += `
                    <tr>
                        <td class="p-2 border border-gray-400">${record.patientName}</td>
                        <td class="p-2 border border-gray-400">${record.patientId}</td>
                        <td class="p-2 border border-gray-400">${record.testName}</td>
                        <td class="p-2 border border-gray-400">${record.testCenter}</td>
                        <td class="p-2 border border-gray-400">${date}</td>
                    </tr>`;
            });

            printContent += `</tbody></table></div>`;
            printArea.innerHTML = printContent;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }

        function deleteRecord(docId) {
            showConfirm('Anda pasti untuk padam rekod ini?', async () => {
                try {
                    await deleteDoc(doc(db, "bloodTestRecords", docId));
                    showToast('Rekod berjaya dipadam.');
                    await fetchRecords(); // Refresh the entire list
                    // After fetching, re-render the current view (which is the records page)
                    applyFilters(); // Re-apply filters to show the correct paginated view
                } catch (error) {
                    console.error("Error deleting record: ", error);
                    showToast("Gagal memadam rekod.", true);
                }
            });
        }

        // --- Autocomplete Logic ---
        function setupAutocomplete(inputId, suggestionBoxId, fieldName) {
            const input = document.getElementById(inputId);
            const suggestionBox = document.getElementById(suggestionBoxId);

            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                if (value.length < 2) {
                    suggestionBox.classList.add('hidden');
                    return;
                }

                const suggestions = [...new Set(allFetchedRecords
                    .map(record => record[fieldName])
                    .filter(item => item.toLowerCase().includes(value))
                )];

                suggestionBox.innerHTML = '';
                if (suggestions.length > 0) {
                    suggestions.slice(0, 5).forEach(suggestion => { // Limit to 5 suggestions
                        const item = document.createElement('div');
                        item.classList.add('suggestion-item');
                        item.textContent = suggestion;
                        item.addEventListener('click', () => {
                            input.value = suggestion;
                            suggestionBox.classList.add('hidden');
                        });
                        suggestionBox.appendChild(item);
                    });
                    suggestionBox.style.width = `${input.offsetWidth}px`;
                    suggestionBox.classList.remove('hidden');
                } else {
                    suggestionBox.classList.add('hidden');
                }
            });
        }

        // --- Modal Logic ---
        function openLocalEditModal(index) {
            const patient = patientList[index];
            document.getElementById('local-edit-index').value = index;
            document.getElementById('local-edit-patient-name').value = patient.name;
            document.getElementById('local-edit-patient-id').value = patient.id;
            document.getElementById('local-edit-test-name').value = patient.test;
            localEditModal.style.display = "flex";
        }

        function closeLocalEditModal() {
            localEditModal.style.display = "none";
        }

        function saveLocalEdit() {
            const index = document.getElementById('local-edit-index').value;
            const newName = document.getElementById('local-edit-patient-name').value.trim();
            const newId = document.getElementById('local-edit-patient-id').value.trim();
            const newTest = document.getElementById('local-edit-test-name').value.trim();

            if (newName && newId && newTest) {
                patientList[index] = { name: newName, id: newId, test: newTest };
                renderTable();
                closeLocalEditModal();
                showToast('Item senarai dikemaskini.');
            } else {
                showToast('Sila isi semua ruangan.', true);
            }
        }

        function openEditModal(docId) {
            const record = allFetchedRecords.find(r => r.id === docId);
            if (!record) return;
            const isoDate = record.dateSent.toDate().toISOString().split('T')[0];
            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-patient-name').value = record.patientName;
            document.getElementById('edit-patient-id').value = record.patientId;
            document.getElementById('edit-test-name').value = record.testName;
            document.getElementById('edit-test-center').value = record.testCenter;
            document.getElementById('edit-date-sent').value = isoDate;
            editModal.style.display = "flex";
        }

        function closeModal() {
            editModal.style.display = "none";
        }

        async function saveEditedRecord() {
            const docId = document.getElementById('edit-doc-id').value;
            const dateValue = document.getElementById('edit-date-sent').value;
            const dateParts = dateValue.split('-').map(part => parseInt(part, 10));
            const localDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

            const updatedRecord = {
                patientName: document.getElementById('edit-patient-name').value,
                patientId: document.getElementById('edit-patient-id').value,
                testName: document.getElementById('edit-test-name').value,
                testCenter: document.getElementById('edit-test-center').value,
                dateSent: Timestamp.fromDate(localDate),
            };

            try {
                await updateDoc(doc(db, "bloodTestRecords", docId), updatedRecord);
                showToast('Rekod berjaya dikemaskini!');
                closeModal();
                fetchRecords(); // Refresh the list to show changes
            } catch (error) {
                console.error('Error updating record:', error);
                showToast('Gagal mengemaskini rekod.', true);
            }
        }

        // Confirmation Modal Logic
        let confirmCallback = null;
        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-modal-text').textContent = message;
            confirmCallback = onConfirm;
            confirmModal.style.display = 'flex';
        }
        document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.style.display = 'none';
        });
        document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
            confirmModal.style.display = 'none';
        });

        // --- Event Listeners ---
        document.getElementById('login-button').addEventListener('click', signInWithGoogle);
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        document.getElementById('show-records-button').addEventListener('click', showRecordsPage);
        document.getElementById('clear-list-button').addEventListener('click', clearList);
        document.getElementById('print-save-button').addEventListener('click', printAndSave);
        document.getElementById('add-patient-button').addEventListener('click', addPatient);
        document.getElementById('back-to-main-button').addEventListener('click', showMainPage);
        document.getElementById('apply-filters-button').addEventListener('click', applyFilters);
        document.getElementById('clear-filters-button').addEventListener('click', clearFilters);
        document.getElementById('print-filtered-button').addEventListener('click', printFiltered);
        
        document.getElementById('local-edit-modal-cancel').addEventListener('click', closeLocalEditModal);
        document.getElementById('local-edit-modal-save').addEventListener('click', saveLocalEdit);
        
        document.getElementById('edit-modal-cancel').addEventListener('click', closeModal);
        document.getElementById('edit-modal-save').addEventListener('click', saveEditedRecord);

        document.getElementById('test-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPatient();
        });

        window.addEventListener('click', (event) => {
            if (event.target == editModal) closeModal();
            if (event.target == localEditModal) closeLocalEditModal();
            if (event.target == confirmModal) confirmModal.style.display = "none";
        });

        // Hide suggestion boxes on outside click
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.relative')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(box => box.classList.add('hidden'));
            }
        });

        // --- Initial Setup ---
        function initialize() {
            renderTable();
            fetchRecords(); // Fetch data on load for suggestions
            setupAutocomplete('patient-name', 'patient-name-suggestions', 'patientName');
            setupAutocomplete('patient-id', 'patient-id-suggestions', 'patientId');
            setupAutocomplete('test-name', 'test-name-suggestions', 'testName');
        }

    </script>
</body>
</html>
